name: Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script_stop: false
          script: |
            cd /var/www/curanova/curanova-web

            # Pull changes
            sudo -u Musnet git pull origin master

            # Check if package.json changed (need npm install)
            CHANGED=$(sudo -u Musnet git diff --name-only HEAD~1 HEAD)
            echo "Changed files: $CHANGED"

            if echo "$CHANGED" | grep -q "package"; then
              echo "Installing dependencies..."
              sudo -u Musnet npm install
            fi

            # Check if source files changed (need rebuild)
            if echo "$CHANGED" | grep -qE "^src/|^content/|\.tsx$|\.ts$|\.json$"; then
              echo "Rebuilding..."
              sudo -u Musnet npm run build
            fi

            # Restart server using PM2
            sudo -u Musnet pm2 restart curanova-web || sudo -u Musnet pm2 start npm --name curanova-web -- start
            echo "Deploy complete"
