name: Deploy to Production

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to GCP VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_KEY }}
          script_stop: false
          script: |
            cd /var/www/curanova/curanova-web

            # Pull changes
            sudo -u Musnet git pull origin master

            # Check if package.json changed (need npm install)
            CHANGED=$(sudo -u Musnet git diff --name-only HEAD~1 HEAD)
            echo "Changed files: $CHANGED"

            if echo "$CHANGED" | grep -q "package"; then
              echo "Installing dependencies..."
              sudo -u Musnet npm install
            fi

            # Check if source files changed (need rebuild)
            if echo "$CHANGED" | grep -qE "^src/|^content/|\.tsx$|\.ts$|\.json$"; then
              echo "Rebuilding..."
              sudo -u Musnet npm run build
            fi

            # Ensure logs directory exists
            sudo -u Musnet mkdir -p /var/www/curanova/logs

            # Stop existing process gracefully
            sudo -u Musnet pm2 delete curanova-web 2>/dev/null || true

            # Start using ecosystem config for better process management
            sudo -u Musnet pm2 start ecosystem.config.js

            # Save PM2 process list to resurrect on reboot
            sudo -u Musnet pm2 save

            # Wait a moment and verify the server is running
            sleep 5
            if sudo -u Musnet pm2 list | grep -q "curanova-web.*online"; then
              echo "Deploy complete - server is running"
            else
              echo "WARNING: Server may not have started correctly"
              sudo -u Musnet pm2 logs curanova-web --lines 20
              exit 1
            fi
